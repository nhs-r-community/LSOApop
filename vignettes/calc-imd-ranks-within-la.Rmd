---
title: "Calculate IMD deciles within local authorities"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{calc-imd-ranks-within-la}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=F, warning=F}
# Load R packages ----
library(LSOApop)
library(dplyr)
library(ggplot2)
library(tidyr)
```

We use the Local Authority "Nottingham" (la_code = "E06000018") for this example.
The distribution of the IMD deciles in this area is relatively unequal compared to the rest of England.
Soetimes a ranked version of the `imd_score` is calculated to present IMDs  be ranked, with 1 representing tbe 'least deprived' and 10 representing the 'least deprived' areas.

```{r fig.width=5, fig.height=5}
# Create object for plot title
plottitle <- "Distribution of decile rankings for LSOAs in\nNotts based on IMD scores for ENG"

# Create plot
imd %>%   
  filter(la_code == "E06000018") %>% 
  ggplot(aes(factor(imd_decile), 
             fill = factor(imd_decile))) +
  geom_bar() +
  scale_fill_viridis_d() +
  labs(x = "IMD decile", 
       y = "Count", 
       fill = NULL) +
  ggtitle(plottitle)
```

In some cases using these deciles may be ideal and it may be useful to recalculate IMD deciles within Local Authorities.

## Calculating IMD deciles within Local Authorities

To recalculate local IMD deciles the data needs to be grouped by Local Authority (`group_by(la_code)`).
Next, calculate deciles using the function `dplyr::ntile()` by specifying `n = 10`.

```{r}
imd_by_la <- imd %>% 
  group_by(la_code) %>% 
  mutate(imd_decile_la = ntile(-imd_score, n = 10))
```

## Compare England and Local IMD deciles for Notts 

To illustrate what has happened in the lines above, the next code chunk prepares the new dataset for plotting.
First we filter the dataset for the Local Authority "Nottingham" using `filter(la_code == "E06000018")` and create a long dataset that can be used for plotting.

```{r}
imd_by_la_plot <- imd_by_la %>% 
  filter(la_code == "E06000018") %>% 
  select(lsoa_code, la_code, la_name, 
         imd_decile_en = imd_decile, 
         imd_decile_la) %>% 
  pivot_longer(cols = c(imd_decile_en, imd_decile_la), 
               names_to = "la_rank_method") %>% 
  mutate(la_rank_method = 
           case_when(la_rank_method == "imd_decile_la" ~ paste0("IMD scores for ", la_name),
                     la_rank_method == "imd_decile_en" ~ "IMD scores for ENG"))
```

As expected, this plot shows a very unequal distribution of IMD deciles when these were calculated based on the whole country and an even distribution when only the Local Authority Nottingham was used to calculate the IMD deciles.

```{r fig.width=7, fig.height=5}
imd_by_la_plot %>%   
  ggplot(aes(factor(value), 
             fill = factor(value))) +
  geom_bar() +
  scale_fill_viridis_d() +
  facet_wrap(~la_rank_method) +
  labs(x = "IMD decile", 
       y = "Count", 
       fill = NULL) +
  ggtitle("Distribution of decile rankings for LSOAs in Notthingham based on:")
```


